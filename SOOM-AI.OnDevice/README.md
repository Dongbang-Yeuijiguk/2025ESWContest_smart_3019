# SOOM-AI.OnDevice
이 저장소는 "SOOM" 프로젝트의 AI 파트를 담고 있습니다. Wi-Fi 채널 상태 정보(CSI)를 활용하여 비침습적인 방식으로 사람의 존재를 감지하고, 움직임을 분류하며, 호흡수를 모니터링합니다. 전체 파이프라인은 온디바이스(엣지 디바이스) 환경에서의 효율적인 추론을 목표로 설계되었습니다.

## flowchart 전체 추론 파이프라인

시스템은 원본 Wi-Fi 신호를 처리하여 사람의 존재와 행동에 대한 의미 있는 정보를 추론하기 위해 구조화된 파이프라인을 통해 작동합니다.

![alt text](image.png)

1.  **데이터 수집**: Wi-Fi 장치에서 원본 CSI 데이터를 수집합니다.
2.  **데이터 전처리**: 원본 데이터를 정제하고 사용 가능한 형태로 변환합니다. 이 과정에는 데이터 로드, 진폭 추출, 노이즈 제거(DWT), 차원 축소(PCA), 저역 통과 필터(FFT)가 포함됩니다.
3.  **존재 감지**: 주변에 사람이 있는지 여부를 먼저 판단합니다. 사람이 없다고 판단되면 파이프라인은 대기 상태에 들어가거나 재시작될 수 있습니다.
4.  **병렬 처리**: 사람이 감지되면, 두 가지 프로세스가 동시에 실행됩니다.
      * **움직임 추론 모델**: 사용자의 현재 행동(예: 앉기, 눕기)을 분류합니다.
      * **BPM 계산 알고리즘**: 사용자의 호흡수를 추정합니다.
5.  **결과 및 통합**: 병렬 처리된 결과와 각 결과의 정확도, 상태 머신 로직 등을 종합하여 최종 결론을 도출합니다.

-----

## 🔬 데이터 및 전처리

### 데이터 소스

입력 데이터는 CSI 측정값으로 구성됩니다. 원본 데이터는 64개의 서브캐리어를 포함하지만, 분석에는 유효한 52개만 사용됩니다. 데이터는 실수부와 허수부로 이루어져 있으나, 위상 정보는 노이즈가 심하고 불안정하여 유용하게 사용하기 어렵기 때문에 진폭 정보만을 사용합니다.

### 전처리 단계

여러 단계의 전처리 파이프라인을 통해 원본 CSI 진폭 데이터를 정제하고, 분석에 용이한 순수 신호를 추출합니다.

1.  **1차 노이즈 제거 (DWT)**: 이산 웨이블릿 변환(DWT)을 적용하여 신호의 초기 노이즈를 제거합니다.
2.  **차원 축소 (PCA)**: 주성분 분석(PCA)을 사용하여 52개의 서브캐리어 데이터를 분산이 가장 큰 단일 시계열 데이터로 축소합니다.
3.  **2차 노이즈 제거 (FFT)**: 고속 푸리에 변환(FFT)을 저역 통과 필터로 사용하여 남아있는 고주파 노이즈를 제거합니다.

아래 이미지는 전체 전처리 파이프라인 적용 전후의 데이터를 비교한 것입니다.

| 원본 CSI 진폭 | 전처리된 PCA 신호 |
| :---: | :---: |
| ![alt text](image-1.png) | ![alt text](image-2.png) |

-----

## 🧠 핵심 로직

### 1\. 사람 존재 판단

신호의 분산(variance)을 분석하여 사람의 존재 유무를 판단합니다. 이는 사람이 공간에 존재할 경우 미세한 움직임으로 인해 신호의 변화가 더 커진다는 원리에 기반합니다. 빈 공간과 사람이 있는 공간을 구분하기 위해 특정 임계값(`PRESENCE_VARIANCE_THRESHOLD = 0.0000075`)을 설정했습니다.

![alt text](image-3.png)

### 2\. 움직임 감지 모델

움직임 분류를 위해 `Simple1DCNN` 모델을 설계했습니다.

**모델 선정 이유**:

  * **온디바이스 제약**: 제한된 데이터셋과 온디바이스 추론 환경을 고려하여 복잡한 모델은 제외했습니다.
  * **RNN 대신 1D CNN을 선택한 이유**: 이 프로젝트의 목표는 시계열 데이터의 장기적인 의존성이 아닌, 순간적인 패턴을 통해 행동을 분류하는 것입니다. RNN과 같이 과거의 맥락을 학습하는 모델은 오히려 성능에 방해가 될 수 있다고 판단했습니다.

| 모델 아키텍처 | 학습 및 검증 정확도 |
| :---: | :---: |
|![alt text](image-5.png) | ![alt text](image-6.png) 
|

### 3\. BPM 계산

BPM 계산은 딥러닝 방식 대신 더 효율적인 통계적 기법을 사용했습니다.

1.  전처리된 1차원 시계열 신호를 FFT를 통해 주파수 스펙트럼으로 변환합니다.
2.  실제 사람의 호흡수 범위에 해당하는 유효 주파수 대역만 필터링합니다.
3.  해당 범위 내에서 가장 강한 신호(magnitude가 가장 큰 주파수)를 핵심 호흡 주파수로 식별합니다.
4.  이 주파수(Hz)에 60을 곱하여 분당 호흡수(BPM) 단위로 변환합니다.

![alt text](image-4.png)

-----

## 🚀 모델 학습 및 성능 향상

### 1\. 데이터 증강

적은 데이터셋의 한계를 극복하기 위해 다음과 같은 데이터 증강 기법들을 사용했습니다.

  * **노이즈 기반**: 가우시안 노이즈를 추가하여 센서 노이즈나 환경 잡음을 모방하고, 모델이 미세한 오차에 과적합되는 것을 방지합니다.
  * **진폭 기반**: 신호 전체에 임의의 상수를 곱하여 입력 장치와의 거리 변화나 녹음 레벨 차이에 강건한 모델을 만듭니다.
  * **변형 기반**: 신호 파형 자체에 미묘한 비선형적 변화를 주어 데이터의 다양성을 확보합니다.
  * **혼합 기반**: 여러 샘플을 조합하여 새로운 샘플을 생성합니다(예: Mixup).

![alt text](image-8.png)

### 2\. 파인튜닝 전략

주기적으로 최신 사용자 데이터를 모델에 반영하여 높은 정확도를 유지하고, 점차 사용자 맞춤형으로 모델을 발전시킵니다.

  * **점진적 학습 (Layer Freezing)**: 파인튜닝 초기에는 사전 학습된 특징 추출기(conv\_block)를 동결시켜, 새로운 데이터의 특성을 분류기(fc\_block)가 먼저 안정적으로 학습하도록 유도합니다.
  * **안정적 가중치 전이 (L2SP Regularization)**: 새로운 가중치가 기존 모델의 가중치에서 너무 멀어지지 않도록 페널티를 부과하여, 소량의 데이터로 인한 과적합을 방지하고 기존 지식을 보존합니다.

-----

## 🛠️ 장애 요인 및 해결 방안

### 1\. 노이즈 제거 필터 선정

노이즈 제거를 위해 칼만 필터와 웨이블릿 필터를 비교했습니다. 정성적 평가 결과, **웨이블릿 필터**가 더 효과적으로 노이즈를 제거하는 것으로 판단하여 최종 선택했습니다.

| 필터 종류 | 원본 vs. 처리 후 결과 |
| :---: | :---: |
| **칼만 필터** | ![alt text](image-9.png) |
| **웨이블릿 필터** | ![alt text](image-10.png) |

### 2\. 엣지 디바이스를 위한 모델 경량화

엣지 디바이스에서의 효율적인 성능을 보장하기 위해, PyTorch 모델을 TensorFlow Lite (TFLite)로 변환하는 경량화를 진행했습니다. 그 결과 모델 크기와 추론 속도에서 상당한 개선을 확인했습니다.

  * **모델 크기 비교**

      * **PyTorch 모델**: 5.82 MB
      * **TFLite 모델**: 1.94 MB

  * **모델 추론 속도 비교** (10,000회 반복 테스트 기준)

      * **PyTorch 모델**: 0.1524 ms
      * **TFLite 모델**: 0.0906 ms
      * **결과**: TFLite 모델이 **1.68배 더 빠릅니다**.
-----

## 📁 폴더 구조
```
SOOM-AI.OnDevice/
│
├── main.py                 # 프로그램 시작 및 전체 흐름 조율
├── config.py               # DB 정보, 모델 경로, 파라미터 등 설정 관리
├── requirements.txt        # 프로젝트 의존성 라이브러리 목록
│
├── data_source/            # 데이터 소스 (InfluxDB 연결 및 데이터 읽기)
│   ├── __init__.py
│   └── influx_connector.py
│
├── models/
│   ├── __init__.py
│   ├── tflite_handler.py     # TFLite 모델 로드 및 추론 전담
│   ├── model_arch.py        # 모델 아키텍처 정의
│   ├── pytorch_handler.py    # PyTorch 모델 로드 및 추론 전담
│   ├── best.pt               # 최적화된 PyTorch 모델
│   └── movement_model.tflite   
│
├── pipeline/               # 핵심 추론 파이프라인 클래스
│   ├── __init__.py
│   └── inference_pipeline.py
│
├── logic/               # 핵심 추론 로직 클래스
│   ├── __init__.py
│   └── sleep_state_manager.py
│
├── result_sink/            # 추론 결과 저장 (InfluxDB에 결과 쓰기)
│   ├── __init__.py
│   └── influx_writer.py
│
├── utils/                  # 재사용 가능한 보조 기능 및 알고리즘
│   ├── __init__.py
│   ├── rt_preprocess.py      # RealtimePreprocessor 클래스
│   ├── signal_processing.py  # FFT, 필터, 정규화 등 순수 신호 처리 함수
│   └── sliding_window.py
│
└── visualize/              # 실시간 시각화 코드
    ├── __init__.py
    └── realtime_plotter.py
```
